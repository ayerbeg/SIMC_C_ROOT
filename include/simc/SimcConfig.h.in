#ifndef SIMC_CONFIG_H
#define SIMC_CONFIG_H

#include <string>
#include <cstdlib>
#include <filesystem>
#include <algorithm>

namespace simc {
namespace config {

// ============================================================================
// Version Information
// ============================================================================

constexpr int VERSION_MAJOR = @PROJECT_VERSION_MAJOR@;
constexpr int VERSION_MINOR = @PROJECT_VERSION_MINOR@;
constexpr int VERSION_PATCH = @PROJECT_VERSION_PATCH@;
constexpr const char* VERSION_STRING = "@PROJECT_VERSION@";

// ============================================================================
// Data Directory Paths
// ============================================================================

// Source data directory (development)
constexpr const char* SOURCE_DATA_DIR = "@SIMC_DATA_DIR@";

// Build data directory (development, after copy_data_files)
constexpr const char* BUILD_DATA_DIR = "@CMAKE_BINARY_DIR@/data";

// Install data directory (after 'make install')
constexpr const char* INSTALL_DATA_DIR = "@SIMC_INSTALL_DATADIR@";

// ============================================================================
// Data Path Resolution
// ============================================================================

inline std::string GetDataDir()
{
    // 1. Environment override (highest priority)
    if (const char* env = std::getenv("SIMC_DATA_DIR")) {
        if (*env && std::filesystem::exists(env)) {
            return std::string(env);
        }
    }

    // 2. Build directory (CTest / development runs)
    if (std::filesystem::exists(BUILD_DATA_DIR)) {
        return std::string(BUILD_DATA_DIR);
    }

    // 3. Install directory
    if (std::filesystem::exists(INSTALL_DATA_DIR)) {
        return std::string(INSTALL_DATA_DIR);
    }

    // 4. Source directory (last resort)
    if (std::filesystem::exists(SOURCE_DATA_DIR)) {
        return std::string(SOURCE_DATA_DIR);
    }

    // Absolute failure is better than silent misbehavior
    throw std::runtime_error("SIMC data directory not found");
}

// ============================================================================
// COSY Matrix Paths
// ============================================================================

inline std::string GetMatrixPath(const std::string& spectrometer,
                                 const std::string& type)
{
    std::string data_dir = GetDataDir();

    std::string spec = spectrometer;
    std::transform(spec.begin(), spec.end(), spec.begin(),
                   [](unsigned char c){ return std::tolower(c); });

    std::string filename;
    if (spec == "shms") {
        filename = "shms_" + type + ".dat";
    } else if (spec == "hrsl" || spec == "hrsr") {
        filename = "hrs_" + type + "_cosy.dat";
    } else {
        filename = type + "_cosy.dat";
    }

    return data_dir + "/matrices/" + spec + "/" + filename;
}

// ============================================================================
// Config and Table Paths
// ============================================================================

inline std::string GetConfigPath(const std::string& name)
{
    return GetDataDir() + "/config/" + name + ".json";
}

inline std::string GetTablePath(const std::string& name)
{
    return GetDataDir() + "/tables/" + name;
}

// ============================================================================
// Build Information
// ============================================================================

constexpr const char* BUILD_TYPE = "@CMAKE_BUILD_TYPE@";
constexpr const char* CXX_COMPILER = "@CMAKE_CXX_COMPILER@";
constexpr const char* CXX_FLAGS = "@CMAKE_CXX_FLAGS@";

} // namespace config
} // namespace simc

#endif // SIMC_CONFIG_H
